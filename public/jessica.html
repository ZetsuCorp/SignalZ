<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jessica Auto Feed</title>
  <link rel="stylesheet" href="jessica.css" />
</head>
<body>
  <h1>ğŸ¤– Jessicaâ€™s Feed</h1>
  <button id="refreshBtn" style="
    display: block;
    margin: 0 auto 2rem auto;
    background: #00f0ff22;
    border: 1px solid #00f0ff55;
    color: #00f0ff;
    padding: 10px 18px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: bold;
  ">ğŸ”„ Refresh Feed</button>

  <div class="jessica-feed" id="feed"></div>

  <script>
    const API_KEY = 'AIzaSyApZmcPKbA0Qcphmz5_8Dt_u_re1VvMd-k';
    const CX = '806ccee4d77894557';

    const queries = [
      { platform: "Twitter", query: "new on twitter" },
      { platform: "X", query: "latest X posts" },
      { platform: "Reddit", query: "breaking reddit news" },
      { platform: "TikTok", query: "viral TikToks July 17" },
    ];

    const feed = document.getElementById('feed');
    const DEFAULT_IMG = 'https://via.placeholder.com/600x300/00f0ff/000?text=Jessica+AI';

    const intros = [
      "â€” Ever wondered whatâ€™s buzzing on",
      "â€” Hot off the wire from",
      "â€” The latest scoop from",
      "â€” Here's whatâ€™s lighting up",
      "â€” Jessica on scene at"
    ];

    const outros = [
      "â€” Find out here",
      "â€” Tap in for the full story",
      "â€” Get the details",
      "â€” Full report below",
      "â€” Read more"
    ];

    async function fetchAndRender({ platform, query }) {
      const url = `https://www.googleapis.com/customsearch/v1?key=${API_KEY}&cx=${CX}&q=${encodeURIComponent(query)}&gl=US&hl=en`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        const posts = (data.items || []).filter(item =>
          item.link &&
          item.snippet && item.snippet.length > 30 &&
          !item.link.includes("feed/trending") &&
          !item.link.includes("explore")
        );

        const timestamp = new Date().toLocaleString();
        const intro = `${intros[Math.floor(Math.random() * intros.length)]} ${platform}`;
        const outro = `${outros[Math.floor(Math.random() * outros.length)]}`;

        return posts.map(item => ({
          platform,
          link: item.link,
          snippet: item.snippet,
          timestamp,
          intro,
          outro
        }));
      } catch (err) {
        console.warn(`Jessica failed on ${platform}:`, err);
        return [];
      }
    }

    function renderPosts(allPosts) {
      feed.innerHTML = '';
      allPosts.forEach(({ platform, link, snippet, timestamp, intro, outro }) => {
        const card = document.createElement('div');
        card.className = 'jessica-post';
        card.innerHTML = `
          <div class="jessica-meta-header">
            <span class="jessica-id">Jessica reporting from â€” ${platform}</span>
          </div>
          <div class="jessica-img">
            <img src="${DEFAULT_IMG}" alt="Preview">
          </div>
          <div class="jessica-meta">
            <span class="jessica-platform">${platform}</span>
            <p class="jessica-intro">${intro}</p>
            <p class="jessica-caption">"${snippet}"</p>
            <span class="jessica-date">${timestamp}</span>
            <p class="jessica-outro">${outro}</p>
          </div>
          <a href="${link}" target="_blank" class="jessica-link">ğŸ”— Open Post</a>
        `;
        feed.appendChild(card);
      });
    }

    async function postToSupabase({ platform, link, snippet, intro, outro }) {
      const payload = {
        headline: intro,
        caption: snippet,
        cta_url: link,
        image_url: DEFAULT_IMG,
        tags: [platform],
        session_id: "jessica-bot",
        wall_type: "main",
        sigicon_url: DEFAULT_IMG,
        display_name: "Jessica AI",
        likes: 0,
        comments: 0,
        reposts: 0
      };

      try {
        const res = await fetch("/.netlify/functions/jessicacreatepost.js", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (res.status === 200) {
          console.log("âœ… Supabase post created:", result.message);
        } else if (res.status === 409) {
          console.log("âš ï¸ Skipped duplicate post:", payload.cta_url);
        } else {
          console.warn("âŒ Failed to create post:", result.error);
        }
      } catch (err) {
        console.error("ğŸš« Network or logic error:", err);
      }
    }

    async function loadJessica() {
      const cached = localStorage.getItem('jessicaFeedCache');
      if (cached) {
        const posts = JSON.parse(cached);
        renderPosts(posts);
      } else {
        const results = await Promise.all(queries.map(fetchAndRender));
        const allPosts = results.flat();
        localStorage.setItem('jessicaFeedCache', JSON.stringify(allPosts));
        renderPosts(allPosts);
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', async () => {
      localStorage.removeItem('jessicaFeedCache');
      const results = await Promise.all(queries.map(fetchAndRender));
      const allPosts = results.flat();
      localStorage.setItem('jessicaFeedCache', JSON.stringify(allPosts));
      renderPosts(allPosts);

      // ğŸ” Send each post to Supabase
      for (const post of allPosts) {
        await postToSupabase(post);
      }
    });

    loadJessica();
  </script>
</body>
</html>
