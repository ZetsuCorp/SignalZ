<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jessica Auto Feed</title>
  <link rel="stylesheet" href="jessica.css" />
</head>
<body>
  <h1>ğŸ¤– Jessicaâ€™s Feed</h1>

  <div class="button-row" style="text-align:center; margin-bottom: 2rem;">
    <button onclick="runSession(1)">ğŸ“¡ Load Session 1</button>
    <button onclick="runSession(2)">ğŸ›°ï¸ Load Session 2</button>
    <button onclick="runSession(3)">ğŸ§  Load Session 3</button>
  </div>

  <div id="feed">
    <section id="session1" class="session-block"><h2>ğŸ“¡ Session 1</h2></section>
    <section id="session2" class="session-block"><h2>ğŸ›°ï¸ Session 2</h2></section>
    <section id="session3" class="session-block"><h2>ğŸ§  Session 3</h2></section>
  </div>

  <script>
    const API_KEY = 'AIzaSyApZmcPKbA0Qcphmz5_8Dt_u_re1VvMd-k';
    const CX = '806ccee4d77894557';

    const queries = [
      { platform: "Twitter", query: "new on twitter" },
      { platform: "X", query: "latest X posts" },
      { platform: "Reddit", query: "breaking reddit news" },
      { platform: "TikTok", query: "viral TikToks July 17" },
      { platform: "Instagram", query: "explore instagram reels" },
      { platform: "YouTube", query: "trending on youtube" },
      { platform: "News", query: "top headlines" },
      { platform: "AI", query: "latest AI tools 2025" },
      { platform: "Crypto", query: "new crypto launches" }
    ];

    const intros = [
      "â€” Ever wondered whatâ€™s buzzing on",
      "â€” Hot off the wire from",
      "â€” The latest scoop from",
      "â€” Here's whatâ€™s lighting up",
      "â€” Jessica on scene at"
    ];

    const outros = [
      "â€” Find out here",
      "â€” Tap in for the full story",
      "â€” Get the details",
      "â€” Full report below",
      "â€” Read more"
    ];

    function generateImageUrl(platform, timestamp) {
      const p = platform.replace(/\W+/g, '').toUpperCase().slice(0, 6);
      const t = timestamp.replace(/\D+/g, '').slice(-6);
      return `https://via.placeholder.com/600x300/00f0ff/000?text=J-${p}-${t}`;
    }

    async function fetchAndRender({ platform, query }) {
      const url = `https://www.googleapis.com/customsearch/v1?key=${API_KEY}&cx=${CX}&q=${encodeURIComponent(query)}&gl=US&hl=en`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        const timestamp = new Date().toLocaleString();
        const intro = `${intros[Math.floor(Math.random() * intros.length)]} ${platform}`;
        const outro = `${outros[Math.floor(Math.random() * outros.length)]}`;

        return (data.items || [])
          .filter(item =>
            item.link &&
            item.snippet?.length > 30 &&
            !item.link.includes("feed/trending") &&
            !item.link.includes("explore")
          )
          .map(item => ({
            platform,
            link: item.link,
            snippet: item.snippet,
            timestamp,
            intro,
            outro,
            image_url: generateImageUrl(platform, new Date().toISOString())
          }));
      } catch (err) {
        console.warn(`Jessica failed on ${platform}:`, err);
        return [];
      }
    }

    async function postToSupabase(post) {
      const payload = {
        headline: post.intro,
        caption: post.snippet,
        cta_url: post.link,
        image_url: post.image_url,
        tags: [post.platform],
        session_id: "jessica-bot",
        wall_type: "main",
        sigicon_url: post.image_url,
        display_name: "Jessica AI",
        likes: 0,
        comments: 0,
        reposts: 0
      };

      try {
        const res = await fetch("/.netlify/functions/jessicacreatepost", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await res.json();
        if (res.status === 200) console.log("âœ… Posted:", post.platform, post.link);
        else console.warn("âŒ Supabase error:", result.error);
      } catch (err) {
        console.error("ğŸš« Network error:", err);
      }
    }

    function renderPosts(containerId, posts) {
      const section = document.getElementById(containerId);
      section.innerHTML = `<h2>${section.querySelector('h2').textContent}</h2>`;

      posts.forEach(post => {
        const card = document.createElement('div');
        card.className = 'jessica-post';
        card.style.backgroundImage = `url('${post.image_url}')`;

        card.innerHTML = `
          <div class="jessica-post-content">
            <div class="jessica-display-name">
              <span>Jessica AI</span>
            </div>

            <div class="jessica-header-line">
              <div class="jessica-sigicon-stack">
                <span class="emoji-icon">ğŸŒ</span>
                <img src="/sigicons/ripple.gif" alt="Ripple" class="ripple-overlay" />
              </div>
              <span class="jessica-id">Jessica reporting from â€” ${post.platform}</span>
            </div>

            <div class="jessica-card-title">ğŸ“› ${post.intro}</div>
            <div class="jessica-card-type">ğŸ“‚ Type â€” SIGZICON</div>

            <p class="jessica-caption">"${post.snippet}"</p>
            <span class="jessica-date">${post.timestamp}</span>
            <p class="jessica-outro">${post.outro}</p>

            <a href="${post.link}" target="_blank" class="jessica-link">ğŸ”— Open Post</a>
          </div>
        `;
        section.appendChild(card);
      });
    }

    async function runSession(sessionNum) {
      const group = {
        1: queries.slice(0, 3),
        2: queries.slice(3, 6),
        3: queries.slice(6, 9)
      }[sessionNum];

      if (!group) return;

      const results = (await Promise.all(group.map(fetchAndRender))).flat();

      renderPosts(`session${sessionNum}`, results);

      for (const post of results) {
        await postToSupabase(post);
      }
    }

    window.addEventListener('DOMContentLoaded', () => runSession(1));
  </script>
</body>
</html>
